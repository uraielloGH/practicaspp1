{% extends 'base.html.twig' %}

{% block title %}Crear cuenta - Brekky{% endblock %}

{% block body %}
<div class="auth-wrapper">
    <div class="auth-card brekky-card">
        
        {# Título y pequeña descripción de qué trata la página #}
        <h1 class="page-title">Crear cuenta</h1>
        <p class="page-subtitle">
            Registrate para empezar a recibir recomendaciones personalizadas
            y guardar tus preferencias en Brekky.
        </p>

        {# Mensajes flash: se usan para avisar si salió bien o hubo algún error #}
        {% for label, messages in app.flashes %}
            {% for message in messages %}
                <div class="flash-message brekky-card" style="margin-bottom: 10px;">
                    {{ message }}
                </div>
            {% endfor %}
        {% endfor %}

        {# Arrancamos el formulario de registro #}
        {{ form_start(registrationForm, {
            attr: {
                class: 'js-loading-form',
                id: 'registration-form'
            }
        }) }}

            {# Campo: nombre completo #}
            <div class="brekky-form-row">
                {{ form_label(registrationForm.nombre, 'Nombre completo') }}
                {{ form_widget(registrationForm.nombre) }}
                {{ form_errors(registrationForm.nombre) }}
            </div>

            {# Campo: correo electrónico #}
            <div class="brekky-form-row">
                {{ form_label(registrationForm.email, 'Correo electrónico') }}
                {{ form_widget(registrationForm.email) }}
                {{ form_errors(registrationForm.email) }}
            </div>

            {# Campo: contraseña (el valor real se convierte después a hash en el controlador) #}
            <div class="brekky-form-row">
                {{ form_label(registrationForm.password, 'Contraseña') }}
                {{ form_widget(registrationForm.password) }}
                {{ form_errors(registrationForm.password) }}
            </div>

            {# Botón principal del formulario #}
            <button type="submit" class="btn-brekky">
                Registrarse
            </button>

        {{ form_end(registrationForm) }}

        {# Links secundarios: iniciar sesión o recuperar contraseña #}
        <p class="auth-secondary">
            ¿Ya tenés cuenta?
            <a href="{{ path('app_login') }}">Iniciá sesión</a>
            o
            <a href="{{ path('app_forgot_password') }}">recuperá tu contraseña</a>.
        </p>
    </div>
</div>
{% endblock %}

{# Esta parte es el script para guardar datos temporales del usuario (FA02 del CU001) #}
{% block javascripts %}
    {{ parent() }}

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('registration-form');
            if (!form) return;

            const STORAGE_KEY = 'brekky_registration_draft';

            // Campos que sí podemos guardar de forma segura
            const nombreInput = form.querySelector('input[name="registration_form[nombre]"]');
            const emailInput  = form.querySelector('input[name="registration_form[email]"]');
            // Por seguridad, nunca guardamos la contraseña en localStorage

            // 1) Si el usuario se había desconectado o recargado la página,
            //    tratamos de recuperar lo que había escrito antes.
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const data = JSON.parse(saved);
                    if (nombreInput && data.nombre) nombreInput.value = data.nombre;
                    if (emailInput && data.email)   emailInput.value  = data.email;
                }
            } catch (e) {
                console.warn('No se pudo leer el borrador de registro', e);
            }

            // 2) Guardar automáticamente cada vez que el usuario escribe
            function saveDraft() {
                const data = {
                    nombre: nombreInput ? nombreInput.value : '',
                    email:  emailInput  ? emailInput.value  : '',
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            }

            if (nombreInput) nombreInput.addEventListener('input', saveDraft);
            if (emailInput)  emailInput.addEventListener('input', saveDraft);

            // 3) Cuando el usuario envía el formulario, borramos el borrador
            form.addEventListener('submit', function () {
                localStorage.removeItem(STORAGE_KEY);
            });
        });
    </script>
{% endblock %}
